{% extends 'base.html' %}

{% block title %}Blossom Word Finder & Solver - Find All Words Instantly{% endblock %}

{% block meta %}
<meta name="description" content="Free Blossom word finder & solver. Instantly find all words and answers to solve today's Merriam-Webster Blossom puzzle.">
<link rel="canonical" href="https://jamesapplewhite.com/blossom">
<meta name="keywords" content="blossom, blossom solver, blossom word finder, merriam webster blossom, blossom game solver, word game solver, blossom hints">
<meta property="og:title" content="Blossom Word Finder & Solver - Find All Words Instantly">
<meta property="og:description" content="Free Blossom word finder & solver. Instantly find all words and answers to solve today's Merriam-Webster Blossom puzzle.">
<meta property="og:url" content="https://jamesapplewhite.com/blossom">
<meta property="og:type" content="website">
<meta property="og:site_name" content="JJ Apps">
{% endblock %}

{% block content %}
<style>
  input::-webkit-input-placeholder {
      color: lightgrey;
  }

  input:-moz-placeholder {
      color: lightgrey;
  }

  input::-moz-placeholder {
      color: lightgrey;
  }

  input:-ms-input-placeholder {
      color: lightgrey;
  }

table.blossom-info {
    width: 50%;
    margin: 20px auto;
    border-collapse: collapse;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-radius: 8px;
    overflow: hidden;
}

  @media (max-width: 768px) {
      table.blossom-info {
          width: 100%;
      }
  }

  table.blossom-info, th, td {
      border: 1px solid black;
      padding: 8px;
      text-align: center;
  }

  .browse-button {
      background-color: #02484d;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      text-align: center;
      margin: 2px;
  }
  
  .browse-button:hover {
      background-color: #03282b;
      color: gray;
  }

  /* Tooltip styles */
  .disclaimer-tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
      color: #666;
      font-size: 12px;
      text-decoration: underline;
      text-decoration-style: dotted;
  }

  .disclaimer-tooltip .tooltip-content {
      visibility: hidden;
      opacity: 0;
      position: absolute;
      bottom: 120%;
      left: 50%;
      transform: translateX(-50%);
      background-color: #333;
      color: white;
      padding: 15px;
      border-radius: 8px;
      width: 350px;
      max-width: 90vw;
      font-size: 13px;
      line-height: 1.4;
      z-index: 1000;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: opacity 0.3s, visibility 0.3s;
  }

  .disclaimer-tooltip .tooltip-content::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 8px solid transparent;
      border-top-color: #333;
  }

  .disclaimer-tooltip:hover .tooltip-content {
      visibility: visible;
      opacity: 1;
  }

  .disclaimer-tooltip .tooltip-content a {
      color: #4A9EFF;
      text-decoration: underline;
  }

  .disclaimer-tooltip .tooltip-content a:hover {
      color: #66B3FF;
  }

  @media (max-width: 480px) {
      .disclaimer-tooltip .tooltip-content {
          width: 300px;
          left: 50%;
          transform: translateX(-50%);
      }
  }

  .used-word {
      background-color: #f0f0f0;
      text-decoration: line-through;
      opacity: 0.6;
  }

  .word-checkbox {
      transform: scale(1.2);
      cursor: pointer;
  }

  table td:first-child {
      width: 50px;
      text-align: center;
  }

  /* New Blossom Layout Styles */
  .blossom-container {
      position: relative;
      width: 400px;
      height: 400px;
      margin: -70px auto -10px auto;
  }

  @media (max-width: 480px) {
      .blossom-container {
          width: 350px;
          height: 350px;
          margin: -70px auto -10px auto;
      }
  }

  /* Override global input styles for blossom */
  .blossom-container input[type="text"] {
      border: none !important;
      background: transparent !important;
      box-sizing: border-box !important;
      width: 100% !important;
      padding: 0 !important;
      margin: 0 !important;
  }

  /* Center letter styling - circular */
  .center-letter {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80px;
      height: 80px;
      background-color: #ffd700;
      border: 3px solid #02484d;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      font-weight: bold;
      text-transform: uppercase;
      cursor: text;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .center-letter input {
      width: 100%;
      height: 100%;
      background: transparent !important;
      border: none !important;
      text-align: center;
      font-size: 32px;
      font-weight: bold;
      text-transform: uppercase;
      outline: none;
      color: #02484d !important;
      -webkit-text-fill-color: #02484d !important;
      -webkit-appearance: none;
      appearance: none;
      padding: 0 !important;
      margin: 0 !important;
      border-radius: 0 !important;
  }
  
  .center-letter input::placeholder {
      color: rgba(2, 72, 77, 0.2);
      opacity: 1;
  }

  /* Petal buttons styling - petal shape */
  .petal-button {
      position: absolute;
      width: 80px;
      height: 80px;
      background-color: #02484d;
      color: white;
      border: 3px solid transparent;
      border-radius: 50% 15% 50% 15%;
      font-size: 28px;
      font-weight: bold;
      text-transform: uppercase;
      cursor: pointer;
      transition: background-color 0.2s, border 0.2s, transform 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  /* Rotate petals to point outward from center */
.petal-1 {
  top: 17.5%;
  left: 24%;
  transform: translateY(0%) rotate(90deg);
}
.petal-1 input {
  transform: rotate(-90deg);
}

.petal-2 {
  top: 17.5%;
  right: 24%;
  transform: translateY(0%) rotate(0deg);
}
.petal-2 input {
  transform: rotate(0deg);
}

.petal-3 {
  top: 40%;
  left: 10%;
  transform: translateY(0%) rotate(45deg);
}
.petal-3 input {
  transform: rotate(-45deg);
}

.petal-4 {
  top: 40%;
  right: 10%;
  transform: translateY(0%) rotate(45deg);
}
.petal-4 input {
  transform: rotate(-45deg);
}

.petal-5 {
  bottom: 17.5%;
  left: 24%;
  transform: translateY(0%) rotate(0deg);
}
.petal-5 input {
  transform: rotate(0deg);
}

.petal-6 {
  bottom: 17.5%;
  right: 24%;
  transform: translateY(0%) rotate(90deg);
}
.petal-6 input {
  transform: rotate(-90deg);
}

/* Update the petal input styles to handle pointer events properly */
.petal-button input {
    width: 100%;
    height: 100%;
    background: transparent !important;
    border: none !important;
    color: #ffffff !important;
    text-align: center;
    font-size: 28px;
    font-weight: bold;
    text-transform: uppercase;
    outline: none;
    cursor: text;
    pointer-events: auto;
    -webkit-text-fill-color: #ffffff !important;
    -webkit-appearance: none;
    appearance: none;
    padding: 0 !important;
    margin: 0 !important;
    border-radius: 0 !important;
}

/* Cherry blossom purple when all letters are complete */
.petal-button.button-mode {
  cursor: pointer;
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
  background-color: #8B5A96;
  transition: background-color 0.5s ease, box-shadow 0.3s ease;
}

.petal-button.button-mode:hover {
  background-color: #7A4D87;
}

/* Selected petal in button mode - keep the gold highlight */
.petal-button.button-mode.selected {
  border: 3px solid #ffd700;
  background-color: #ffd700;
}

.petal-button.button-mode.selected input[type="text"] {
  color: #02484d !important;
  -webkit-text-fill-color: #02484d !important;
}

/* Make sure text stays white on purple petals */
.petal-button.button-mode input[type="text"] {
  color: #ffffff !important;
  -webkit-text-fill-color: #ffffff !important;
}

.petal-button:not(.button-mode) {
    cursor: text;
}

.petal-button input::placeholder {
      color: rgba(255, 255, 255, 0.2);
      opacity: 1;
  }

  .petal-button:hover {
      background-color: #03282b;
  }

.petal-button.selected {
    border: 3px solid #ffd700;
    background-color: #ffd700;
}

.petal-button.selected input[type="text"] {
    color: #02484d !important;
    -webkit-text-fill-color: #02484d !important;
}

@media (max-width: 480px) {
    .petal-1 { top: 17.5%; left: 22%; }
    .petal-2 { top: 17.5%; right: 22%; }
    .petal-3 { top: 39%; left: 10%; }
    .petal-4 { top: 39%; right: 10%; }
    .petal-5 { bottom: 17.5%; left: 22%; }
    .petal-6 { bottom: 17.5%; right: 22%; }
}

/* Force input text to be visible */
  input[type="text"] {
      -webkit-user-select: text;
      user-select: text;
  }
  
  /* Additional fallback for text visibility */
  .petal-button input:not(:placeholder-shown) {
      color: #ffffff !important;
      -webkit-text-fill-color: #ffffff !important;
  }
  
  .center-letter input:not(:placeholder-shown) {
      color: #02484d !important;
      -webkit-text-fill-color: #02484d !important;
  }

/* Make demo placeholders appear faint */
.petal-button input:placeholder-shown,
.center-letter input:placeholder-shown {
    opacity: 0.12;
}

.petal-button:not(.button-mode) {
  cursor: text;
}

.petal-button:not(.button-mode):hover {
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}

/* Duplicate warning styling */
.duplicate-warning {
  display: block;
  position: fixed;
  top: 70px;
  left: 50%;
  transform: translateX(-50%);
  background-color: #ff6b6b;
  color: white;
  padding: 12px 20px;
  border: 2px solid #e55555;
  border-radius: 6px;
  font-weight: bold;
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
  z-index: 2001;
  font-size: 14px;
  max-width: 90vw;
  text-align: center;
}

/* Mobile-specific positioning for warnings */
@media (max-width: 768px) {
  .duplicate-warning {
    top: 20px;
    font-size: 13px;
    padding: 10px 16px;
    margin: 0 5%;
    max-width: 90%;
    left: 50%;
    transform: translateX(-50%);
  }
}

/* Even more visible on small screens */
@media (max-width: 480px) {
  .duplicate-warning {
    top: 15px;
    font-size: 12px;
    padding: 8px 12px;
    border-radius: 4px;
    margin: 0 10px;
    max-width: calc(100% - 20px);
    left: 50%;
    transform: translateX(-50%);
  }
}

/* Subtle entrance animation to draw attention */
@keyframes warningSlideIn {
  0% {
    opacity: 0;
    transform: translateX(-50%) translateY(-10px);
  }
  100% {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
}

.duplicate-warning {
  animation: warningSlideIn 0.3s ease-out;
}

/* Helper mode styles */
.helper-mode-toggle {
    background-color: #f5f5f5;
    border: 1px solid #ddd;
    color: #666;
    padding: 12px 24px;
    border-radius: 12px 18px 12px 18px;
    cursor: pointer;
    font-size: 12px;
    font-family: inherit;
    text-decoration: none;
    display: inline-block;
    position: relative;
    z-index: 10;
    margin-top: -40px;
    margin-right: 10px;
    transition: all 0.2s ease;
}

.helper-mode-toggle:hover {
    background-color: #e9ecef;
    text-decoration: none !important;
    color: #666 !important;
    transform: scale(1.03) !important;
}

/* Purple "ON" state */
.helper-mode-toggle.helper-mode-on {
    background-color: #8B5A96;
    color: white;
    border-color: #8B5A96;
}

.helper-mode-toggle.helper-mode-on:hover {
    background-color: #7A4D87;
    color: white !important;
}

.show-letter-btn {
    background-color: #02484d;
    color: white;
    padding: 4px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s ease;
}

.show-letter-btn:hover {
    background-color: #03282b;
}

.show-letter-btn:disabled {
    background-color: #ccc;
    cursor: not-allowed;
}

/* Helper mode word display */
.word-masked {
    font-family: monospace;
    letter-spacing: 2px;
}

/* Show Letter column styling */
th.show-letter-header,
td.show-letter-cell {
    text-align: center;
    width: 80px;
    padding: 4px;
}

/* Hide elements in helper mode */
.helper-mode-hidden {
    display: none !important;
}

</style>

<script>
// Simple, lightweight tracking only for essential functionality
let centerLetter = '';
let petalLetters = ['', '', '', '', '', ''];
let selectedPetal = '';

// Update hidden form inputs
function updateHiddenInputs() {
  document.querySelector('input[name="must_have"]').value = centerLetter;
  document.querySelector('input[name="may_have"]').value = petalLetters.join('');
}

// Handle center letter input - letters only
function handleCenterInput(input) {
  // Remove any non-letter characters and convert to uppercase
  const cleanedValue = input.value.replace(/[^A-Za-z]/g, '').toUpperCase();
  const newLetter = cleanedValue.slice(0, 1); // Take only first letter
  
  if (newLetter.length === 1) {
    const duplicateCheck = checkForDuplicates(newLetter, -1, true);
    if (duplicateCheck.isDuplicate) {
      showDuplicateWarning(newLetter, duplicateCheck.position);
      input.value = centerLetter;
      return;
    }
  }
  
  centerLetter = newLetter;
  input.value = centerLetter;
  updatePetalVisualState();
  
  if (centerLetter.length === 1) {
    const nextEmpty = findNextEmptyCell();
    if (nextEmpty) {
      document.getElementById(nextEmpty.element).focus();
    }
  }
  
  updateHiddenInputs();
}

// Handle petal letter input - letters only
function handlePetalInput(input, index) {
  // Remove any non-letter characters and convert to uppercase
  const cleanedValue = input.value.replace(/[^A-Za-z]/g, '').toUpperCase();
  const newLetter = cleanedValue.slice(0, 1); // Take only first letter
  
  if (newLetter.length === 1) {
    const duplicateCheck = checkForDuplicates(newLetter, index, false);
    if (duplicateCheck.isDuplicate) {
      showDuplicateWarning(newLetter, duplicateCheck.position);
      input.value = petalLetters[index];
      return;
    }
  }
  
  petalLetters[index] = newLetter;
  input.value = newLetter;
  updatePetalVisualState();

  if (newLetter.length === 1) {
    const nextEmpty = findNextEmptyCell('petal');
    if (nextEmpty) {
      document.getElementById(nextEmpty.element).focus();
    } else {
      input.blur();
    }
  }
  
  updateHiddenInputs();
}

// Additional function to handle keydown events and prevent non-letter input
function handleKeyDown(event) {
  const key = event.key;
  
  // Allow navigation keys
  if (['Backspace', 'Delete', 'Tab', 'Escape', 'Enter', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(key)) {
    return true;
  }
  
  // Allow modifier keys (Ctrl, Alt, Shift, etc.)
  if (event.ctrlKey || event.metaKey || event.altKey || key === 'Shift' || key === 'Control' || key === 'Alt' || key === 'Meta') {
    return true;
  }
  
  // Only allow letters A-Z (both uppercase and lowercase)
  if (!/^[A-Za-z]$/.test(key)) {
    event.preventDefault();
    
    // Show warning for invalid character
    showInvalidCharacterWarning(key);
    
    return false;
  }
  
  return true;
}

// Show invalid character warning
function showInvalidCharacterWarning(character) {
  // Remove existing warning if any
  const existingWarning = document.getElementById('invalid-char-warning');
  if (existingWarning) {
    existingWarning.remove();
  }
  
  // Create warning element
  const warning = document.createElement('div');
  warning.id = 'invalid-char-warning';
  warning.className = 'duplicate-warning'; // Reuse existing styling
  
  // Customize message based on character type
  let message = '';
  if (/\d/.test(character)) {
    message = `Numbers like "${character}" are not allowed. Please enter letters only!`;
  } else if (character === ' ') {
    message = `Spaces are not allowed. Please enter letters only!`;
  } else if (/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(character)) {
    message = `Special characters like "${character}" are not allowed. Please enter letters only!`;
  } else {
    message = `"${character}" is not allowed. Please enter letters A-Z only!`;
  }
  
  warning.textContent = message;
  
  document.body.appendChild(warning);

  // Auto-remove warning after 3 seconds
  setTimeout(() => {
    if (warning && warning.parentNode) {
      warning.style.transition = 'opacity 0.5s ease';
      warning.style.opacity = '0';
      setTimeout(() => {
        if (warning && warning.parentNode) {
          warning.remove();
        }
      }, 500);
    }
  }, 2500);
}

// Check if all letters are entered
function areAllLettersEntered() {
  return centerLetter.length === 1 && petalLetters.filter(l => l.length === 1).length === 6;
}

// Select petal for solving
function selectPetal(index) {
  if (!areAllLettersEntered()) {
    document.getElementById(`petal-${index}`).focus();
    return;
  }

  if (!centerLetter) {
    showCenterWarning();
    return;
  }

  if (petalLetters[index]) {
    selectedPetal = petalLetters[index];
    document.querySelector('input[name="petal_letter"]').value = selectedPetal;
    
    document.querySelectorAll('.petal-button').forEach(btn => btn.classList.remove('selected'));
    document.querySelector(`.petal-${index + 1}`).classList.add('selected');
    
    document.querySelector('form[name="form1"]').submit();
  }
}

// Handle backspace navigation
function handleBackspace(input, index, isCenter) {
  if (input.value === '') {
    if (isCenter) return;
    
    if (index > 0) {
      document.getElementById(`petal-${index - 1}`).focus();
    } else {
      document.getElementById('center-input').focus();
    }
  }
}

// Update visual state of petals
function updatePetalVisualState() {
  const allLettersEntered = areAllLettersEntered();
  const petals = document.querySelectorAll('.petal-button');
  
  petals.forEach((petal, index) => {
    if (allLettersEntered && petalLetters[index].length === 1) {
      petal.classList.add('button-mode');
      petal.title = `Click to solve with bonus letter ${petalLetters[index]}`;
    } else {
      petal.classList.remove('button-mode');
      petal.classList.remove('selected');
      petal.title = 'Click to enter a letter';
    }
  });

  const instruction = document.querySelector('.pad_lr_30');
  if (instruction) {
    if (allLettersEntered) {
      instruction.textContent = 'All letters entered! Click any petal to calculate words with that bonus letter.';
    } else {
      instruction.textContent = 'Enter letters below to match the Blossom game you aim to solve.';
    }
  }
}

// Check for duplicate letters
function checkForDuplicates(newLetter, currentIndex, isCenter = false) {
  const allLetters = [centerLetter, ...petalLetters];
  const newLetterUpper = newLetter.toUpperCase();
  
  for (let i = 0; i < allLetters.length; i++) {
    const existingLetter = allLetters[i];
    
    if (!existingLetter) continue;
    if (isCenter && i === 0) continue;
    if (!isCenter && i === currentIndex + 1) continue;
    
    if (existingLetter.toUpperCase() === newLetterUpper) {
      return {
        isDuplicate: true,
        position: i === 0 ? 'center' : `petal ${i}`,
        letter: existingLetter
      };
    }
  }
  
  return { isDuplicate: false };
}

// Show center warning
function showCenterWarning() {
  const warning = document.getElementById('center-warning');
  warning.style.display = 'block';
  warning.style.opacity = '1';

  setTimeout(() => {
    warning.style.transition = 'opacity 0.5s ease';
    warning.style.opacity = '0';
  }, 1500);

  setTimeout(() => {
    warning.style.display = 'none';
    warning.style.transition = '';
  }, 2000);
}

// Show duplicate warning
function showDuplicateWarning(letter, position) {
  // Remove existing warning if any
  const existingWarning = document.getElementById('duplicate-warning');
  if (existingWarning) {
    existingWarning.remove();
  }
  
  // Create warning element
  const warning = document.createElement('div');
  warning.id = 'duplicate-warning';
  warning.className = 'duplicate-warning';
  warning.textContent = `Letter "${letter}" is already used in the ${position}!`;
  
  document.body.appendChild(warning);

  // Auto-remove warning after 3 seconds
  setTimeout(() => {
    if (warning && warning.parentNode) {
      warning.style.transition = 'opacity 0.5s ease';
      warning.style.opacity = '0';
      setTimeout(() => {
        if (warning && warning.parentNode) {
          warning.remove();
        }
      }, 500);
    }
  }, 2500);
}

// Find next empty cell
function findNextEmptyCell(currentContext = 'any') {
  if (currentContext === 'petal') {
    for (let i = 0; i < 6; i++) {
      if (!petalLetters[i]) {
        return { element: `petal-${i}` };
      }
    }
    
    if (!centerLetter) {
      return { element: 'center-input' };
    }
  } else {
    if (!centerLetter) {
      return { element: 'center-input' };
    }
    
    for (let i = 0; i < 6; i++) {
      if (!petalLetters[i]) {
        return { element: `petal-${i}` };
      }
    }
  }
  
  return null;
}
function handleCheckboxChange(checkbox) {
  const word = checkbox.getAttribute('data-word');
  const row = checkbox.closest('tr');
  
  if (checkbox.checked) {
    row.classList.add('used-word');
  } else {
    row.classList.remove('used-word');
  }

  // Server sync
  fetch('/blossom', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      action: 'toggle_word',
      word: word
    })
  })
  .then(response => response.json())
  .catch(error => {
    console.error('Error updating word status:', error);
    // Revert on error
    checkbox.checked = !checkbox.checked;
    if (checkbox.checked) {
      row.classList.add('used-word');
    } else {
      row.classList.remove('used-word');
    }
  });
}

// Reset confirmation
function showResetConfirmation(event) {
  event.preventDefault();
  
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  `;
  
  const dialog = document.createElement('div');
  dialog.style.cssText = `
    background: white;
    padding: 24px;
    border-radius: 12px;
    max-width: 320px;
    margin: 20px;
    text-align: center;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    font-family: inherit;
  `;
  
  dialog.innerHTML = `
    <h3 style="margin: 0 0 12px 0; color: #333; font-size: 18px;">Reset Letters?</h3>
    <p style="margin: 0 0 20px 0; color: #666; line-height: 1.4;">This will clear all your current letters and words marked as "Used". Are you sure you want to continue?</p>
    <div style="display: flex; gap: 12px; justify-content: center;">
      <button onclick="cancelReset()" style="
        background-color: #f5f5f5;
        border: 1px solid #ddd;
        color: #666;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-family: inherit;
      ">Cancel</button>
      <button onclick="confirmReset()" style="
        background-color: #02484d;
        border: 1px solid #02484d;
        color: white;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-family: inherit;
      ">Reset Letters</button>
    </div>
  `;
  
  modal.appendChild(dialog);
  document.body.appendChild(modal);
  
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      cancelReset();
    }
  });
  
  window.currentModal = modal;
}

function cancelReset() {
  if (window.currentModal) {
    document.body.removeChild(window.currentModal);
    window.currentModal = null;
  }
}

function confirmReset() {
  // Clear helper mode state including revealed letters
  sessionStorage.removeItem('blossomHelperMode');
  revealedLetters = {};
  
  window.location.href = '/blossom/reset';
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  // Get initial values from template
  const initialCenter = '{{must_have_val}}';
  const initialPetals = '{{may_have_val}}';
  const initialSelectedPetal = '{{petal_letter}}';
  
  // Set initial values
  if (initialCenter) {
    centerLetter = initialCenter.toUpperCase();
    document.getElementById('center-input').value = centerLetter;
  }

  if (initialPetals) {
    for (let i = 0; i < initialPetals.length && i < 6; i++) {
      petalLetters[i] = initialPetals[i].toUpperCase();
      document.getElementById(`petal-${i}`).value = petalLetters[i];
    }
  }

  updatePetalVisualState();

  // Highlight selected petal
  if (initialSelectedPetal) {
    const petalIndex = petalLetters.indexOf(initialSelectedPetal.toUpperCase());
    if (petalIndex !== -1) {
      document.querySelector(`.petal-${petalIndex + 1}`).classList.add('selected');
    }
  }
  
  // Add event listeners to checkboxes
  const checkboxes = document.querySelectorAll('.word-checkbox');
  checkboxes.forEach(checkbox => {
    const row = checkbox.closest('tr');
    if (checkbox.checked) {
      row.classList.add('used-word');
    }
    
    checkbox.addEventListener('change', function() {
      handleCheckboxChange(this);
    });
  });

  // Auto-focus center input on first load if it's empty
  if (!centerLetter) {
    document.getElementById('center-input').focus();
  }
});

// Helper mode functionality
let isHelperMode = false;
let revealedLetters = {}; // Track how many letters are revealed for each word

// Store helper mode in sessionStorage to persist across table updates
function saveHelperModeState() {
    sessionStorage.setItem('blossomHelperMode', JSON.stringify({
        isHelperMode: isHelperMode,
        revealedLetters: revealedLetters
    }));
}

// Load helper mode state
function loadHelperModeState() {
    const saved = sessionStorage.getItem('blossomHelperMode');
    if (saved) {
        const state = JSON.parse(saved);
        isHelperMode = state.isHelperMode;
        revealedLetters = state.revealedLetters || {};
    }
}

// Toggle helper mode
function toggleHelperMode() {
    isHelperMode = !isHelperMode;
    
    // Update button text and style
    const toggleBtn = document.getElementById('helper-mode-toggle');
    if (toggleBtn) {
        if (isHelperMode) {
            toggleBtn.textContent = 'Helper Mode: ON';
            toggleBtn.classList.add('helper-mode-on');
        } else {
            toggleBtn.textContent = 'Helper Mode: OFF';
            toggleBtn.classList.remove('helper-mode-on');
        }
    }
    
    // Reset revealed letters when switching modes
    if (!isHelperMode) {
        revealedLetters = {};
    }
    
    // Save state
    saveHelperModeState();
    
    // Update table display
    updateTableForHelperMode();
}

// Mask word based on revealed letters count
function maskWord(word, revealCount = 1) {
    if (!word || word.length === 0) return '';
    
    // Show first letter and specified number of additional letters
    let masked = word[0];
    for (let i = 1; i < word.length; i++) {
        if (i < revealCount) {
            masked += word[i];
        } else {
            masked += '_';
        }
    }
    return masked;
}

// Show next letter for a word
function showNextLetter(word, event) {
    // Prevent any default button behavior
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    if (!revealedLetters[word]) {
        revealedLetters[word] = 2; // Start with 2 (first letter + one more)
    } else {
        revealedLetters[word]++;
    }
    
    // Save state
    saveHelperModeState();
    
    // Update just this word's display
    updateWordDisplay(word);
    
    // Return false to prevent any form submission
    return false;
}

// Update display for a specific word
function updateWordDisplay(word) {
    const wordCell = document.querySelector(`td[data-word="${word}"]`);
    if (!wordCell) return;
    
    const revealCount = revealedLetters[word] || 1;
    const maskedWord = maskWord(word, revealCount);
    wordCell.textContent = maskedWord;
    
    // Update button state
    const row = wordCell.closest('tr');
    const showLetterBtn = row.querySelector('.show-letter-btn');
    if (showLetterBtn) {
        if (revealCount >= word.length) {
            showLetterBtn.disabled = true;
            showLetterBtn.textContent = 'Shown';
        } else {
            showLetterBtn.disabled = false;
            showLetterBtn.textContent = 'Show';
        }
    }
}

// Update entire table for helper mode
function updateTableForHelperMode() {
    const table = document.querySelector('table');
    if (!table) return;
    
    // Handle header row
    const headerRow = table.querySelector('thead tr') || table.querySelector('tr');
    if (headerRow) {
        // Remove existing "Show Letter" header if any
        const existingShowHeader = headerRow.querySelector('.show-letter-header');
        if (existingShowHeader) {
            existingShowHeader.remove();
        }
        
        if (isHelperMode) {
            // Add "Show Letter" header
            const showLetterHeader = document.createElement('th');
            showLetterHeader.className = 'show-letter-header';
            showLetterHeader.textContent = 'Hint';
            headerRow.appendChild(showLetterHeader);
        }
    }
    
    // Handle data rows
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
        const wordCell = row.querySelector('td:nth-child(2)'); // Assuming word is in 2nd column
        if (!wordCell) return;
        
        // Get the original word (stored as data attribute or from checkbox)
        const checkbox = row.querySelector('.word-checkbox');
        const word = checkbox ? checkbox.getAttribute('data-word') : wordCell.textContent;
        
        // Store original word as data attribute if not already there
        if (!wordCell.hasAttribute('data-word')) {
            wordCell.setAttribute('data-word', word);
        }
        
        // Remove existing show letter cell if any
        const existingShowCell = row.querySelector('.show-letter-cell');
        if (existingShowCell) {
            existingShowCell.remove();
        }
        
        if (isHelperMode) {
            // Add word class for styling
            wordCell.classList.add('word-masked');
            
            // Mask the word
            const revealCount = revealedLetters[word] || 1;
            wordCell.textContent = maskWord(word, revealCount);
            
            // Add "Show Letter" button cell
            const showLetterCell = document.createElement('td');
            showLetterCell.className = 'show-letter-cell';
            
            const showLetterBtn = document.createElement('button');
            showLetterBtn.className = 'show-letter-btn';
            showLetterBtn.type = 'button'; // Explicitly set type to prevent form submission
            showLetterBtn.textContent = revealCount >= word.length ? 'Shown' : 'Show';
            showLetterBtn.disabled = revealCount >= word.length;
            showLetterBtn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                showNextLetter(word, e);
                return false;
            };
            
            showLetterCell.appendChild(showLetterBtn);
            row.appendChild(showLetterCell);
        } else {
            // Restore original word
            wordCell.classList.remove('word-masked');
            wordCell.textContent = word;
        }
    });
}

// Create or update the helper mode button
function createHelperModeButton() {
    // Check if button already exists
    if (document.getElementById('helper-mode-toggle')) {
        return;
    }
    
    const resetButton = document.querySelector('a[onclick*="showResetConfirmation"]');
    if (resetButton) {
        // 1. Create the wrapper span for the tooltip
        const tooltipWrapper = document.createElement('span');
        tooltipWrapper.className = 'disclaimer-tooltip';
        
        // 2. Create the Helper Mode button (<a> element)
        const toggleButton = document.createElement('a');
        toggleButton.id = 'helper-mode-toggle';
        toggleButton.className = 'helper-mode-toggle';
        toggleButton.textContent = isHelperMode ? 'Helper Mode: ON' : 'Helper Mode: OFF';
        if (isHelperMode) {
            toggleButton.classList.add('helper-mode-on');
        }
        toggleButton.href = '#';
        
        // Add the click handler with the setTimeout for automatic dismissal
        toggleButton.onclick = function(e) {
            e.preventDefault();
            toggleHelperMode();
            
            // Explicitly make the tooltip content visible on click
            tooltipContent.style.visibility = 'visible';
            tooltipContent.style.opacity = '1';

            // Set the timeout to hide the tooltip after 2 seconds
            setTimeout(() => {
                // Hide the tooltip content
                tooltipContent.style.visibility = 'hidden';
                tooltipContent.style.opacity = '0';
            }, 2000); // 2000 milliseconds = 2 seconds
        };

        // 3. Create the tooltip content span
        const tooltipContent = document.createElement('span');
        tooltipContent.className = 'tooltip-content';
        tooltipContent.textContent = 'When ON, words are masked, and you can reveal one letter at a time.';
        
        // 4. Append the button and content to the wrapper
        tooltipWrapper.appendChild(toggleButton);
        tooltipWrapper.appendChild(tooltipContent);
        
        // 5. Insert the wrapper before the Reset button
        resetButton.parentNode.insertBefore(tooltipWrapper, resetButton);
    }
}

// Initialize helper mode on page load and after any table updates
function initializeHelperMode() {
    // Load saved state
    loadHelperModeState();
    
    // Create button if it doesn't exist
    createHelperModeButton();
    
    // Store original words as data attributes
    const wordCells = document.querySelectorAll('table td:nth-child(2)');
    wordCells.forEach(cell => {
        const checkbox = cell.parentElement.querySelector('.word-checkbox');
        if (checkbox) {
            const word = checkbox.getAttribute('data-word');
            cell.setAttribute('data-word', word);
        }
    });
    
    // Apply helper mode if active
    if (isHelperMode) {
        updateTableForHelperMode();
    }
}

// Override the existing DOMContentLoaded or add to it
document.addEventListener('DOMContentLoaded', function() {
    initializeHelperMode();
});

// Watch for table changes using MutationObserver
const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
        if (mutation.type === 'childList') {
            // Check if a table was added or modified
            const hasTableChange = Array.from(mutation.addedNodes).some(node => 
                node.nodeName === 'TABLE' || (node.querySelector && node.querySelector('table'))
            );
            
            if (hasTableChange) {
                // Re-initialize helper mode after table update
                setTimeout(initializeHelperMode, 10);
            }
        }
    });
});

// Start observing the document for changes
observer.observe(document.body, {
    childList: true,
    subtree: true
});

// Modify the handleCheckboxChange function to work with helper mode
if (typeof handleCheckboxChange !== 'undefined') {
    const originalHandleCheckboxChange = handleCheckboxChange;
    handleCheckboxChange = function(checkbox) {
        // Call original function
        originalHandleCheckboxChange(checkbox);
        
        // If in helper mode, ensure the word display is maintained
        if (isHelperMode) {
            const word = checkbox.getAttribute('data-word');
            const row = checkbox.closest('tr');
            const wordCell = row.querySelector('td[data-word]');
            if (wordCell) {
                const revealCount = revealedLetters[word] || 1;
                wordCell.textContent = maskWord(word, revealCount);
            }
        }
    };
}

// Preserve helper mode state during form submissions
document.addEventListener('submit', function(e) {
    if (e.target && e.target.matches('form[name="form1"]')) {
        // State is already saved in sessionStorage, so it will persist
        saveHelperModeState();
    }
}, true);

</script>

<form name="form1" action="/blossom" method="post">
  <center>

  <div id="center-warning" style="
    display: none;
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #ffd700;
    color: #02484d;
    padding: 10px 20px;
    border: 2px solid #02484d;
    border-radius: 6px;
    font-weight: bold;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    z-index: 2000;
  ">
    Please enter the center letter first.
  </div>

  <input type="hidden" name="current_count" value="{{current_count|default(25)}}">
  <input type="hidden" name="must_have" value="{{must_have_val}}">
  <input type="hidden" name="may_have" value="{{may_have_val}}">
  <input type="hidden" name="petal_letter" value="{{petal_letter}}">

  <br>
  <h1 style="text-align: center; font-size: clamp(1.5rem, 4vw, 2.5rem); line-height: 1.2;">Blossom Word Finder & Solver</h1>

  <p class="pad_lr_30" style="text-align: center">Enter your letters below. Click any petal to calculate words with that bonus letter.</p>
  <br>

  <!-- New Blossom Layout -->
  <div class="blossom-container">

  <!-- Center Letter -->
  <div class="center-letter">
    <input type="text" id="center-input" maxlength="1" placeholder="A" 
           oninput="handleCenterInput(this)" 
           onkeydown="handleKeyDown(event); if(event.key === 'Backspace') handleBackspace(this, 0, true)">
  </div>
  
  <!-- Petal Letters -->
  <button type="button" class="petal-button petal-1" onclick="selectPetal(0)">
    <input type="text" id="petal-0" maxlength="1" placeholder="B" 
          oninput="handlePetalInput(this, 0)" 
          onkeydown="handleKeyDown(event); if(event.key === 'Backspace') handleBackspace(this, 0, false)">
  </button>

  <button type="button" class="petal-button petal-2" onclick="selectPetal(1)">
    <input type="text" id="petal-1" maxlength="1" placeholder="C" 
          oninput="handlePetalInput(this, 1)" 
          onkeydown="handleKeyDown(event); if(event.key === 'Backspace') handleBackspace(this, 1, false)">
  </button>

  <button type="button" class="petal-button petal-3" onclick="selectPetal(2)">
    <input type="text" id="petal-2" maxlength="1" placeholder="D" 
          oninput="handlePetalInput(this, 2)" 
          onkeydown="handleKeyDown(event); if(event.key === 'Backspace') handleBackspace(this, 2, false)">
  </button>

  <button type="button" class="petal-button petal-4" onclick="selectPetal(3)">
    <input type="text" id="petal-3" maxlength="1" placeholder="E" 
          oninput="handlePetalInput(this, 3)" 
          onkeydown="handleKeyDown(event); if(event.key === 'Backspace') handleBackspace(this, 3, false)">
  </button>

  <button type="button" class="petal-button petal-5" onclick="selectPetal(4)">
    <input type="text" id="petal-4" maxlength="1" placeholder="F" 
          oninput="handlePetalInput(this, 4)" 
          onkeydown="handleKeyDown(event); if(event.key === 'Backspace') handleBackspace(this, 4, false)">
  </button>

  <button type="button" class="petal-button petal-6" onclick="selectPetal(5)">
    <input type="text" id="petal-5" maxlength="1" placeholder="G" 
          oninput="handlePetalInput(this, 5)" 
          onkeydown="handleKeyDown(event); if(event.key === 'Backspace') handleBackspace(this, 5, false)">
  </button>
  </div>
  
<a href="#" style="
    background-color: #f5f5f5;
    border: 1px solid #ddd;
    color: #666;
    padding: 12px 24px;
    border-radius: 12px 18px 12px 18px;
    cursor: pointer;
    font-size: 12px;
    font-family: inherit;
    text-decoration: none;
    display: inline-block;
    position: relative;
    z-index: 10;
    margin-top: -40px;
" onclick="showResetConfirmation(event);">Reset Letters</a>
  <br>
  <br>

  {{blossom_table|safe}}
  <br>
  {% if show_load_more %}
  <form method="POST" action="/blossom" style="display: inline;">
    <input type="hidden" name="must_have" value="{{must_have_val}}">
    <input type="hidden" name="may_have" value="{{may_have_val}}">
    <input type="hidden" name="petal_letter" value="{{petal_letter}}">
    <input type="hidden" name="current_count" value="{{current_count}}">
    <button type="submit" name="load_more" value="true" style="
        background-color: #f5f5f5;
        border: 1px solid #ddd;
        color: #666;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        font-family: inherit;
    ">+ Show 25 more</button>
  </form>
  <br>
  <br>
  {% endif %}
  {{valid_word_count}}

  <br>
  <br>
  <br>
  <p style="text-align: center; max-width: 800px; margin: 0 auto; padding: 0 20px;">
    Blossom is Merriam-Webster's daily word puzzle where you create words using a center letter and surrounding petals. Enter your letters above to find all possible words and solve today's puzzle instantly.
  </p>

  <div style="margin: 20px 0; text-align: center;">
    <a href="https://www.merriam-webster.com/games/blossom-word-game" target="_blank" style="
        background-color: #f8f9fa;
        color: #495057;
        border: 1px solid #e9ecef;
        padding: 12px 20px;
        border-radius: 8px;
        text-decoration: none;
        display: inline-block;
        margin: 4px;
        font-size: 14px;
        transition: all 0.2s ease;
    " onmouseover="this.style.backgroundColor='#e9ecef'" onmouseout="this.style.backgroundColor='#f8f9fa'">🌸 Play Blossom</a>
    <a href="/feedback" style="
        background-color: #f8f9fa;
        color: #495057;
        border: 1px solid #e9ecef;
        padding: 12px 20px;
        border-radius: 8px;
        text-decoration: none;
        display: inline-block;
        margin: 4px;
        font-size: 14px;
        transition: all 0.2s ease;
    " onmouseover="this.style.backgroundColor='#e9ecef'" onmouseout="this.style.backgroundColor='#f8f9fa'">💬 Feedback</a>
    </div>    
    <div style="margin-top: 20px;">
      <p style="font-size: 13px; color: #888; margin-bottom: 12px;">Other Word Game Solvers:</p>
        <div style="
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 4px;
            max-width: 300px;
            margin: 0 auto;
        ">
          <a href="/wordle" style="
              background-color: #f8f9fa;
              color: #495057;
              border: 1px solid #e9ecef;
              padding: 8px 16px;
              border-radius: 6px;
              text-decoration: none;
              display: inline-block;
              font-size: 13px;
              transition: all 0.2s ease;
              flex: 0 0 calc(50% - 2px);
              text-align: center;
              box-sizing: border-box;
          " onmouseover="this.style.backgroundColor='#e9ecef'" onmouseout="this.style.backgroundColor='#f8f9fa'">Wordle</a>
          
          <a href="/quordle" style="
              background-color: #f8f9fa;
              color: #495057;
              border: 1px solid #e9ecef;
              padding: 8px 16px;
              border-radius: 6px;
              text-decoration: none;
              display: inline-block;
              font-size: 13px;
              transition: all 0.2s ease;
              flex: 0 0 calc(50% - 2px);
              text-align: center;
              box-sizing: border-box;
          " onmouseover="this.style.backgroundColor='#e9ecef'" onmouseout="this.style.backgroundColor='#f8f9fa'">Quordle</a>
          
          <a href="/antiwordle" style="
              background-color: #f8f9fa;
              color: #495057;
              border: 1px solid #e9ecef;
              padding: 8px 16px;
              border-radius: 6px;
              text-decoration: none;
              display: inline-block;
              font-size: 13px;
              transition: all 0.2s ease;
              flex: 0 0 calc(50% - 2px);
              text-align: center;
              box-sizing: border-box;
          " onmouseover="this.style.backgroundColor='#e9ecef'" onmouseout="this.style.backgroundColor='#f8f9fa'">Antiwordle</a>
        </div>
    </div>
  </div>

  </p>
  <p style="text-align: center; max-width: 800px; margin: 0 auto; padding: 0 20px;">
    <span class="disclaimer-tooltip">
      About this tool
      <span class="tooltip-content">
        This is an unofficial tool to help with Merriam-Webster's Blossom word game. The word list comes from this <a href="https://github.com/MagicOctopusUrn/wordListsByLength" target="_blank" rel="noopener noreferrer">GitHub</a> and may not always align with the valid words in the official game. Results are provided for assistance and entertainment purposes only. This tool is not affiliated with or endorsed by Merriam-Webster.
      </span>
    </span>
  </p>
  <br>
  <br>
  </center>
</form>

{% endblock %}