{% extends 'base.html' %}

{% block title %}Blossom Word Finder & Solver - Find All Words Instantly{% endblock %}

{% block meta %}
<meta name="description" content="Free Blossom word finder. Enter letters to instantly find all words and solve today's Merriam-Webster Blossom puzzle.">
{% endblock %}

{% block content %}
<style>
  /* Existing styles preserved */
  input::-webkit-input-placeholder {
      color: lightgrey;
  }

  input:-moz-placeholder {
      color: lightgrey;
  }

  input::-moz-placeholder {
      color: lightgrey;
  }

  input:-ms-input-placeholder {
      color: lightgrey;
  }

  table.blossom-info {
      width: 50%;
      margin-left: auto;
      margin-right: auto;
      border-collapse: collapse;
  }

  @media (max-width: 768px) {
      table.blossom-info {
          width: 100%;
      }
  }

  table.blossom-info, th, td {
      border: 1px solid black;
      padding: 8px;
      text-align: center;
  }

  .browse-button {
      background-color: #02484d;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      text-align: center;
  }
  
  .browse-button:hover {
      background-color: #03282b;
      color: gray;
  }

  .used-word {
      background-color: #f0f0f0;
      text-decoration: line-through;
      opacity: 0.6;
  }

  .word-checkbox {
      transform: scale(1.2);
      cursor: pointer;
  }

  table td:first-child {
      width: 50px;
      text-align: center;
  }

  /* New Blossom Layout Styles */
  .blossom-container {
      position: relative;
      width: 400px;
      height: 400px;
      margin: 20px auto;
  }

  @media (max-width: 480px) {
      .blossom-container {
          width: 350px;
          height: 350px;
      }
  }

  /* Override global input styles for blossom */
  .blossom-container input[type="text"] {
      border: none !important;
      background: transparent !important;
      box-sizing: border-box !important;
      width: 100% !important;
      padding: 0 !important;
      margin: 0 !important;
  }

  /* Center letter styling - circular */
  .center-letter {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80px;
      height: 80px;
      background-color: #ffd700;
      border: 3px solid #02484d;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      font-weight: bold;
      text-transform: uppercase;
      cursor: text;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .center-letter input {
      width: 100%;
      height: 100%;
      background: transparent !important;
      border: none !important;
      text-align: center;
      font-size: 32px;
      font-weight: bold;
      text-transform: uppercase;
      outline: none;
      color: #02484d !important;
      -webkit-text-fill-color: #02484d !important;
      -webkit-appearance: none;
      appearance: none;
      padding: 0 !important;
      margin: 0 !important;
      border-radius: 0 !important;
  }
  
  .center-letter input::placeholder {
      color: rgba(2, 72, 77, 0.2);
      opacity: 1;
  }

  /* Petal buttons styling - petal shape */
  .petal-button {
      position: absolute;
      width: 80px;
      height: 80px;
      background-color: #02484d;
      color: white;
      border: 3px solid transparent;
      border-radius: 50% 15% 50% 15%;
      font-size: 28px;
      font-weight: bold;
      text-transform: uppercase;
      cursor: pointer;
      transition: background-color 0.2s, border 0.2s, transform 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  /* Rotate petals to point outward from center */
.petal-1 {
  top: 70px;
  left: 90px;
  transform: translateY(0%) rotate(90deg);
}
.petal-1 input {
  transform: rotate(-90deg);
}

.petal-2 {
  top: 70px;
  right: 90px;
  transform: translateY(0%) rotate(0deg);
}
.petal-2 input {
  transform: rotate(0deg);
}

.petal-3 {
  top: 160px;
  left: 40px;
  transform: translateY(0%) rotate(45deg);
}
.petal-3 input {
  transform: rotate(-45deg);
}

.petal-4 {
  top: 160px;
  right: 40px;
  transform: translateY(0%) rotate(45deg);
}
.petal-4 input {
  transform: rotate(-45deg);
}

.petal-5 {
  bottom: 70px;
  left: 90px;
  transform: translateY(0%) rotate(0deg);
}
.petal-5 input {
  transform: rotate(0deg);
}

.petal-6 {
  bottom: 70px;
  right: 90px;
  transform: translateY(0%) rotate(90deg);
}
.petal-6 input {
  transform: rotate(-90deg);
}


  .petal-button input {
      width: 100%;
      height: 100%;
      background: transparent !important;
      border: none !important;
      color: #ffffff !important;
      text-align: center;
      font-size: 28px;
      font-weight: bold;
      text-transform: uppercase;
      outline: none;
      cursor: pointer;
      pointer-events: none;
      -webkit-text-fill-color: #ffffff !important;
      -webkit-appearance: none;
      appearance: none;
      padding: 0 !important;
      margin: 0 !important;
      border-radius: 0 !important;
  }
  
  .petal-button input::placeholder {
      color: rgba(255, 255, 255, 0.2);
      opacity: 1;
  }

  .petal-button:hover {
      background-color: #03282b;
  }

  .petal-button.selected {
      border: 3px solid #ca9546;
      background-color: #03282b;
  }

  @media (max-width: 480px) {
      .petal-1 { top: 45px; left: 45px; }
      .petal-2 { top: 45px; right: 45px; }
      .petal-3 { right: 25px; }
      .petal-4 { bottom: 45px; right: 45px; }
      .petal-5 { bottom: 45px; left: 45px; }
      .petal-6 { left: 25px; }
  }

  /* Force input text to be visible */
  input[type="text"] {
      -webkit-user-select: text;
      user-select: text;
  }
  
  /* Additional fallback for text visibility */
  .petal-button input:not(:placeholder-shown) {
      color: #ffffff !important;
      -webkit-text-fill-color: #ffffff !important;
  }
  
  .center-letter input:not(:placeholder-shown) {
      color: #02484d !important;
      -webkit-text-fill-color: #02484d !important;
  }

/* Make demo placeholders appear faint */
.petal-button input:placeholder-shown,
.center-letter input:placeholder-shown {
    opacity: 0.2;
}
</style>

<script>
// Safe gtag function that won't crash if GA isn't loaded
function safeTrack(eventName, properties = {}) {
  try {
    if (typeof gtag !== 'undefined') {
      gtag('event', eventName, properties);
    }
  } catch (error) {
    // Silently fail - analytics shouldn't break functionality
  }
}

// Variables to track current petal and letter values
let currentPetalIndex = 0;
let centerLetter = '';
let petalLetters = ['', '', '', '', '', ''];
let selectedPetal = '';

// Function to update the hidden form inputs
function updateHiddenInputs() {
  document.querySelector('input[name="must_have"]').value = centerLetter;
  document.querySelector('input[name="may_have"]').value = petalLetters.join('');
}

// Function to handle center letter input
function handleCenterInput(input) {
  centerLetter = input.value.toUpperCase();
  input.value = centerLetter;
  
  if (centerLetter.length === 1) {
    // Move to first petal
    document.getElementById('petal-0').focus();
    
    // Track center letter entry
    safeTrack('center_letter_entered', {
      'event_category': 'blossom_solver',
      'event_label': 'center_letter_complete',
      'custom_parameters': {
        'letter': centerLetter.toLowerCase()
      }
    });
  }
  
  updateHiddenInputs();
}

// Function to handle petal input
function handlePetalInput(input, index) {
  const letter = input.value.toUpperCase();
  input.value = letter;
  petalLetters[index] = letter;
  
  if (letter.length === 1) {
    // Auto-advance to next petal
    if (index < 5) {
      document.getElementById(`petal-${index + 1}`).focus();
    } else {
      // All petals filled, blur current input
      input.blur();
      
      // Track completion
      safeTrack('input_complete', {
        'event_category': 'blossom_solver',
        'event_label': 'petal_letters_entered',
        'custom_parameters': {
          'input_length': 6,
          'letters': petalLetters.join('').toLowerCase()
        }
      });
    }
  }
  
  updateHiddenInputs();
}

// Function to handle petal click (submit form with selected petal)
function selectPetal(index) {
  if (petalLetters[index]) {
    selectedPetal = petalLetters[index];
    document.querySelector('input[name="petal_letter"]').value = selectedPetal;
    
    // Update visual selection
    document.querySelectorAll('.petal-button').forEach(btn => btn.classList.remove('selected'));
    document.querySelector(`.petal-${index + 1}`).classList.add('selected');
    
    // Track petal selection
    safeTrack('petal_letter_selected', {
      'event_category': 'blossom_solver',
      'event_label': 'letter_' + selectedPetal.toLowerCase(),
      'custom_parameters': {
        'selected_letter': selectedPetal.toLowerCase(),
        'total_letters': petalLetters.filter(l => l).length,
        'is_reselection': false
      }
    });
    
    // Submit form
    document.querySelector('form[name="form1"]').submit();
  }
}

// Function to handle backspace navigation
function handleBackspace(input, index, isCenter) {
  if (input.value === '') {
    if (isCenter) return;
    
    if (index > 0) {
      document.getElementById(`petal-${index - 1}`).focus();
    } else {
      document.getElementById('center-input').focus();
    }
  }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  // Get initial values from template
  const initialCenter = '{{must_have_val}}';
  const initialPetals = '{{may_have_val}}';
  const initialSelectedPetal = '{{petal_letter}}';
  
  // Set initial values
  if (initialCenter) {
    centerLetter = initialCenter.toUpperCase();
    document.getElementById('center-input').value = centerLetter;
  }
  
  if (initialPetals) {
    for (let i = 0; i < initialPetals.length && i < 6; i++) {
      petalLetters[i] = initialPetals[i].toUpperCase();
      document.getElementById(`petal-${i}`).value = petalLetters[i];
    }
  }
  
  // Highlight selected petal
  if (initialSelectedPetal) {
    const petalIndex = petalLetters.indexOf(initialSelectedPetal.toUpperCase());
    if (petalIndex !== -1) {
      document.querySelector(`.petal-${petalIndex + 1}`).classList.add('selected');
    }
  }
  
  // Add event listeners to checkboxes
  const checkboxes = document.querySelectorAll('.word-checkbox');
  checkboxes.forEach(checkbox => {
    const row = checkbox.closest('tr');
    if (checkbox.checked) {
      row.classList.add('used-word');
    }
    
    checkbox.addEventListener('change', function() {
      handleCheckboxChange(this);
    });
  });
  
  // Track initial page view
  safeTrack('page_view', {
    'event_category': 'blossom_solver',
    'event_label': 'solver_loaded',
    'custom_parameters': {
      'has_existing_data': centerLetter.length > 0 || petalLetters.join('').length > 0,
      'center_letter_present': centerLetter.length > 0,
      'petal_letters_complete': petalLetters.join('').length === 6,
      'page_type': 'blossom_solver'
    }
  });
});

// Existing checkbox handling function
function handleCheckboxChange(checkbox) {
  const word = checkbox.getAttribute('data-word');
  const row = checkbox.closest('tr');
  const isChecking = checkbox.checked;
  const wordLength = word ? word.length : 0;
  
  if (isChecking) {
    row.classList.add('used-word');
  } else {
    row.classList.remove('used-word');
  }

  safeTrack('word_interaction', {
    'event_category': 'blossom_solver',
    'event_label': isChecking ? 'word_marked_used' : 'word_unmarked',
    'custom_parameters': {
      'word_length': wordLength,
      'word': word,
      'action': isChecking ? 'mark' : 'unmark'
    }
  });

  fetch('/blossom', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      action: 'toggle_word',
      word: word
    })
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    return response.json();
  })
  .then(data => {
    if (data.status === 'success') {
      safeTrack('word_status_updated', {
        'event_category': 'blossom_solver',
        'event_label': 'server_sync_success',
        'custom_parameters': {
          'word': word,
          'new_status': isChecking ? 'used' : 'available'
        }
      });
    }
  })
  .catch(error => {
    console.error('Error updating word status:', error);
    checkbox.checked = !checkbox.checked;
    if (checkbox.checked) {
      row.classList.add('used-word');
    } else {
      row.classList.remove('used-word');
    }
  });
}
</script>

<form name="form1" action="/blossom" method="post">
  <center>

  <input type="hidden" name="current_count" value="{{current_count|default(25)}}">
  <input type="hidden" name="must_have" value="{{must_have_val}}">
  <input type="hidden" name="may_have" value="{{may_have_val}}">
  <input type="hidden" name="petal_letter" value="{{petal_letter}}">

  <br>
  <h1 style="text-align: center; font-size: clamp(1.5rem, 4vw, 2.5rem); line-height: 1.2;">Blossom Word Finder & Solver</h1>

  <!-- New Blossom Layout -->
  <div class="blossom-container">
    <!-- Center Letter -->
    <div class="center-letter">
      <input type="text" id="center-input" maxlength="1" placeholder="A" 
             oninput="handleCenterInput(this)" 
             onkeydown="if(event.key === 'Backspace') handleBackspace(this, 0, true)">
    </div>
    
    <!-- Petal Letters -->
    <button type="button" class="petal-button petal-1" onclick="selectPetal(0)">
      <input type="text" id="petal-0" maxlength="1" placeholder="B" 
             oninput="handlePetalInput(this, 0)" 
             onkeydown="if(event.key === 'Backspace') handleBackspace(this, 0, false)"
             onfocus="this.parentElement.style.pointerEvents='none'"
             onblur="this.parentElement.style.pointerEvents='auto'">
    </button>
    
    <button type="button" class="petal-button petal-2" onclick="selectPetal(1)">
      <input type="text" id="petal-1" maxlength="1" placeholder="C" 
             oninput="handlePetalInput(this, 1)" 
             onkeydown="if(event.key === 'Backspace') handleBackspace(this, 1, false)"
             onfocus="this.parentElement.style.pointerEvents='none'"
             onblur="this.parentElement.style.pointerEvents='auto'">
    </button>
    
    <button type="button" class="petal-button petal-3" onclick="selectPetal(2)">
      <input type="text" id="petal-2" maxlength="1" placeholder="D" 
             oninput="handlePetalInput(this, 2)" 
             onkeydown="if(event.key === 'Backspace') handleBackspace(this, 2, false)"
             onfocus="this.parentElement.style.pointerEvents='none'"
             onblur="this.parentElement.style.pointerEvents='auto'">
    </button>
    
    <button type="button" class="petal-button petal-4" onclick="selectPetal(3)">
      <input type="text" id="petal-3" maxlength="1" placeholder="E" 
             oninput="handlePetalInput(this, 3)" 
             onkeydown="if(event.key === 'Backspace') handleBackspace(this, 3, false)"
             onfocus="this.parentElement.style.pointerEvents='none'"
             onblur="this.parentElement.style.pointerEvents='auto'">
    </button>
    
    <button type="button" class="petal-button petal-5" onclick="selectPetal(4)">
      <input type="text" id="petal-4" maxlength="1" placeholder="F" 
             oninput="handlePetalInput(this, 4)" 
             onkeydown="if(event.key === 'Backspace') handleBackspace(this, 4, false)"
             onfocus="this.parentElement.style.pointerEvents='none'"
             onblur="this.parentElement.style.pointerEvents='auto'">
    </button>
    
    <button type="button" class="petal-button petal-6" onclick="selectPetal(5)">
      <input type="text" id="petal-5" maxlength="1" placeholder="G" 
             oninput="handlePetalInput(this, 5)" 
             onkeydown="if(event.key === 'Backspace') handleBackspace(this, 5, false)"
             onfocus="this.parentElement.style.pointerEvents='none'"
             onblur="this.parentElement.style.pointerEvents='auto'">
    </button>
  </div>

  <p class="pad_lr_30" style="text-align: center">Enter your letters above. Click any petal to calculate words with that bonus letter.</p>

  {{blossom_table|safe}}
  <br>
  {% if show_load_more %}
  <form method="POST" action="/blossom" style="display: inline;">
    <input type="hidden" name="must_have" value="{{must_have_val}}">
    <input type="hidden" name="may_have" value="{{may_have_val}}">
    <input type="hidden" name="petal_letter" value="{{petal_letter}}">
    <input type="hidden" name="current_count" value="{{current_count}}">
    <button type="submit" name="load_more" value="true" style="
        background-color: #f5f5f5;
        border: 1px solid #ddd;
        color: #666;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        font-family: inherit;
    ">+ Show 25 more</button>
  </form>
  <br>
  <br>
  {% endif %}
  {{valid_word_count}}

  <br>
  <br>
  <br>
  <a href="/blossom/reset" style="display: inline-block;">
    <div class="spinning-image">
      <img alt="Reset" src="/static/reset_logo.png">
    </div>
  </a>
  <p style="text-align: center; font-size: 12px; margin-top: 5px; color: #666;">
    Reset checked words
  </p>
  <br>
  <p style="text-align: center; max-width: 800px; margin: 0 auto; padding: 0 20px;">
    Blossom is Merriam-Webster's daily word puzzle where you create words using a center letter and surrounding petals. Enter your letters above to find all possible words and solve today's puzzle instantly.
  </p>
  <br>
  <p class="pad_lr_30" style="text-align: center; max-width: 800px; margin: 0 auto; padding: 0 20px;">
    Disclaimer: This is an unofficial tool to help with Merriam-Webster's Blossom word game. The word list comes from this <a href="https://github.com/MagicOctopusUrn/wordListsByLength" target="_blank" rel="noopener noreferrer">GitHub</a> and may not always align with the valid words in the official game. Results are provided for assistance and entertainment purposes only. This tool is not affiliated with or endorsed by Merriam-Webster.
  </p>
  <br>
  <a href="https://www.merriam-webster.com/games/blossom-word-game" target="_blank">Go To Blossom Game</a>
  <br>
  <br>
  <a href="/feedback">Give Feedback Here</a>
  <br>
  <br>
  <a href="/wordle" class="browse-button">Wordle Solver</a>
  <a href="/quordle" class="browse-button">Quordle Solver</a>
  <a href="/antiwordle" class="browse-button">Antiwordle Solver</a>
  <a href="/blossom_bee" class="browse-button">Spelling Bee Solver</a>
  <br>
  <br>
  <br>
  </center>
</form>

{% endblock %}