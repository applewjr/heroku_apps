{% extends 'base.html' %}

{% block title %}Blossom Word Finder & Solver - Find All Words Instantly{% endblock %}

{% block meta %}
<meta name="description" content="Free Blossom word finder. Enter letters to instantly find all words and solve today's Merriam-Webster Blossom puzzle.">
{% endblock %}

{% block content %}
<style>
  /* Existing styles preserved */
  input::-webkit-input-placeholder {
      color: lightgrey;
  }

  input:-moz-placeholder {
      color: lightgrey;
  }

  input::-moz-placeholder {
      color: lightgrey;
  }

  input:-ms-input-placeholder {
      color: lightgrey;
  }

table.blossom-info {
    width: 50%;
    margin: 20px auto;
    border-collapse: collapse;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-radius: 8px;
    overflow: hidden;
}

  @media (max-width: 768px) {
      table.blossom-info {
          width: 100%;
      }
  }

  table.blossom-info, th, td {
      border: 1px solid black;
      padding: 8px;
      text-align: center;
  }

  .browse-button {
      background-color: #02484d;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      text-align: center;
      margin: 2px;
  }
  
  .browse-button:hover {
      background-color: #03282b;
      color: gray;
  }

  /* Tooltip styles */
  .disclaimer-tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
      color: #666;
      font-size: 12px;
      text-decoration: underline;
      text-decoration-style: dotted;
  }

  .disclaimer-tooltip .tooltip-content {
      visibility: hidden;
      opacity: 0;
      position: absolute;
      bottom: 120%;
      left: 50%;
      transform: translateX(-50%);
      background-color: #333;
      color: white;
      padding: 15px;
      border-radius: 8px;
      width: 350px;
      max-width: 90vw;
      font-size: 13px;
      line-height: 1.4;
      z-index: 1000;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: opacity 0.3s, visibility 0.3s;
  }

  .disclaimer-tooltip .tooltip-content::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 8px solid transparent;
      border-top-color: #333;
  }

  .disclaimer-tooltip:hover .tooltip-content {
      visibility: visible;
      opacity: 1;
  }

  .disclaimer-tooltip .tooltip-content a {
      color: #4A9EFF;
      text-decoration: underline;
  }

  .disclaimer-tooltip .tooltip-content a:hover {
      color: #66B3FF;
  }

  @media (max-width: 480px) {
      .disclaimer-tooltip .tooltip-content {
          width: 300px;
          left: 50%;
          transform: translateX(-50%);
      }
  }

  .used-word {
      background-color: #f0f0f0;
      text-decoration: line-through;
      opacity: 0.6;
  }

  .word-checkbox {
      transform: scale(1.2);
      cursor: pointer;
  }

  table td:first-child {
      width: 50px;
      text-align: center;
  }

  /* New Blossom Layout Styles */
  .blossom-container {
      position: relative;
      width: 400px;
      height: 400px;
      margin: -30px auto 0px auto;
  }

  @media (max-width: 480px) {
      .blossom-container {
          width: 350px;
          height: 350px;
      }
  }

  /* Override global input styles for blossom */
  .blossom-container input[type="text"] {
      border: none !important;
      background: transparent !important;
      box-sizing: border-box !important;
      width: 100% !important;
      padding: 0 !important;
      margin: 0 !important;
  }

  /* Center letter styling - circular */
  .center-letter {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80px;
      height: 80px;
      background-color: #ffd700;
      border: 3px solid #02484d;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      font-weight: bold;
      text-transform: uppercase;
      cursor: text;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .center-letter input {
      width: 100%;
      height: 100%;
      background: transparent !important;
      border: none !important;
      text-align: center;
      font-size: 32px;
      font-weight: bold;
      text-transform: uppercase;
      outline: none;
      color: #02484d !important;
      -webkit-text-fill-color: #02484d !important;
      -webkit-appearance: none;
      appearance: none;
      padding: 0 !important;
      margin: 0 !important;
      border-radius: 0 !important;
  }
  
  .center-letter input::placeholder {
      color: rgba(2, 72, 77, 0.2);
      opacity: 1;
  }

  /* Petal buttons styling - petal shape */
  .petal-button {
      position: absolute;
      width: 80px;
      height: 80px;
      background-color: #02484d;
      color: white;
      border: 3px solid transparent;
      border-radius: 50% 15% 50% 15%;
      font-size: 28px;
      font-weight: bold;
      text-transform: uppercase;
      cursor: pointer;
      transition: background-color 0.2s, border 0.2s, transform 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  /* Rotate petals to point outward from center */
.petal-1 {
  top: 17.5%;
  left: 24%;
  transform: translateY(0%) rotate(90deg);
}
.petal-1 input {
  transform: rotate(-90deg);
}

.petal-2 {
  top: 17.5%;
  right: 24%;
  transform: translateY(0%) rotate(0deg);
}
.petal-2 input {
  transform: rotate(0deg);
}

.petal-3 {
  top: 40%;
  left: 10%;
  transform: translateY(0%) rotate(45deg);
}
.petal-3 input {
  transform: rotate(-45deg);
}

.petal-4 {
  top: 40%;
  right: 10%;
  transform: translateY(0%) rotate(45deg);
}
.petal-4 input {
  transform: rotate(-45deg);
}

.petal-5 {
  bottom: 17.5%;
  left: 24%;
  transform: translateY(0%) rotate(0deg);
}
.petal-5 input {
  transform: rotate(0deg);
}

.petal-6 {
  bottom: 17.5%;
  right: 24%;
  transform: translateY(0%) rotate(90deg);
}
.petal-6 input {
  transform: rotate(-90deg);
}

/* Update the petal input styles to handle pointer events properly */
.petal-button input {
    width: 100%;
    height: 100%;
    background: transparent !important;
    border: none !important;
    color: #ffffff !important;
    text-align: center;
    font-size: 28px;
    font-weight: bold;
    text-transform: uppercase;
    outline: none;
    cursor: text; /* Change to text cursor by default */
    pointer-events: auto; /* Enable pointer events */
    -webkit-text-fill-color: #ffffff !important;
    -webkit-appearance: none;
    appearance: none;
    padding: 0 !important;
    margin: 0 !important;
    border-radius: 0 !important;
}

/* Cherry blossom purple when all letters are complete */
.petal-button.button-mode {
  cursor: pointer;
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
  background-color: #8B5A96; /* Cherry blossom purple */
  transition: background-color 0.5s ease, box-shadow 0.3s ease;
}

.petal-button.button-mode:hover {
  background-color: #7A4D87; /* Slightly darker purple on hover */
}

/* Selected petal in button mode - keep the gold highlight */
.petal-button.button-mode.selected {
  border: 3px solid #ffd700;
  background-color: #ffd700;
}

.petal-button.button-mode.selected input[type="text"] {
  color: #02484d !important;
  -webkit-text-fill-color: #02484d !important;
}

/* Make sure text stays white on purple petals */
.petal-button.button-mode input[type="text"] {
  color: #ffffff !important;
  -webkit-text-fill-color: #ffffff !important;
}

.petal-button:not(.button-mode) {
    cursor: text;
}

.petal-button input::placeholder {
      color: rgba(255, 255, 255, 0.2);
      opacity: 1;
  }

  .petal-button:hover {
      background-color: #03282b;
  }

.petal-button.selected {
    border: 3px solid #ffd700;
    background-color: #ffd700;
}

.petal-button.selected input[type="text"] {
    color: #02484d !important;
    -webkit-text-fill-color: #02484d !important;
}

@media (max-width: 480px) {
    .petal-1 { top: 17.5%; left: 22%; }
    .petal-2 { top: 17.5%; right: 22%; }
    .petal-3 { top: 39%; left: 10%; }
    .petal-4 { top: 39%; right: 10%; }
    .petal-5 { bottom: 17.5%; left: 22%; }
    .petal-6 { bottom: 17.5%; right: 22%; }
}

/* Force input text to be visible */
  input[type="text"] {
      -webkit-user-select: text;
      user-select: text;
  }
  
  /* Additional fallback for text visibility */
  .petal-button input:not(:placeholder-shown) {
      color: #ffffff !important;
      -webkit-text-fill-color: #ffffff !important;
  }
  
  .center-letter input:not(:placeholder-shown) {
      color: #02484d !important;
      -webkit-text-fill-color: #02484d !important;
  }

/* Make demo placeholders appear faint */
.petal-button input:placeholder-shown,
.center-letter input:placeholder-shown {
    opacity: 0.2;
}

.petal-button:not(.button-mode) {
  cursor: text;
}

.petal-button:not(.button-mode):hover {
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}

</style>

<script>
// Safe gtag function that won't crash if GA isn't loaded
function safeTrack(eventName, properties = {}) {
  try {
    if (typeof gtag !== 'undefined') {
      gtag('event', eventName, properties);
    }
  } catch (error) {
    // Silently fail - analytics shouldn't break functionality
  }
}

// Variables to track current petal and letter values
let currentPetalIndex = 0;
let centerLetter = '';
let petalLetters = ['', '', '', '', '', ''];
let selectedPetal = '';
let sessionStartTime = Date.now();
let lastInteractionTime = Date.now();

// Function to update the hidden form inputs
function updateHiddenInputs() {
  document.querySelector('input[name="must_have"]').value = centerLetter;
  document.querySelector('input[name="may_have"]').value = petalLetters.join('');
}

// Updated handleCenterInput function
function handleCenterInput(input) {
  const previousValue = centerLetter;
  const newLetter = input.value.toUpperCase();
  
  // Check for duplicates if there's a new letter
  if (newLetter.length === 1) {
    const duplicateCheck = checkForDuplicates(newLetter, -1, true);
    if (duplicateCheck.isDuplicate) {
      // Revert to previous value
      input.value = previousValue;
      showDuplicateWarning(newLetter, duplicateCheck.position);
      return;
    }
  }
  
  centerLetter = newLetter;
  input.value = centerLetter;

  // Update visual state
  updatePetalVisualState();

  if (centerLetter.length === 1 && previousValue.length === 0) {
    // Move to next empty cell
    const nextEmpty = findNextEmptyCell();
    if (nextEmpty) {
      document.getElementById(nextEmpty.element).focus();
    }
    
    // Track center letter entry
    safeTrack('center_letter_entered', {
      'event_category': 'blossom_solver',
      'event_label': 'center_letter_complete',
      'value': 1,
      'custom_parameters': {
        'letter': centerLetter.toLowerCase(),
        'time_to_enter': Date.now() - sessionStartTime,
        'session_duration': Date.now() - sessionStartTime
      }
    });
  }
  
  // Track center letter change
  if (previousValue !== centerLetter && centerLetter.length > 0) {
    safeTrack('letter_changed', {
      'event_category': 'blossom_solver',
      'event_label': 'center_letter_modified',
      'custom_parameters': {
        'from_letter': previousValue.toLowerCase(),
        'to_letter': centerLetter.toLowerCase(),
        'change_type': 'center'
      }
    });
  }
  
  updateHiddenInputs();
  lastInteractionTime = Date.now();
}


// Function to check if all letters are entered
function areAllLettersEntered() {
  return centerLetter.length === 1 && petalLetters.filter(l => l.length === 1).length === 6;
}

// Updated handlePetalInput function
function handlePetalInput(input, index) {
  const previousValue = petalLetters[index];
  const newLetter = input.value.toUpperCase();
  
  // Check for duplicates if there's a new letter
  if (newLetter.length === 1) {
    const duplicateCheck = checkForDuplicates(newLetter, index, false);
    if (duplicateCheck.isDuplicate) {
      // Revert to previous value
      input.value = previousValue;
      petalLetters[index] = previousValue;
      showDuplicateWarning(newLetter, duplicateCheck.position);
      return;
    }
  }
  
  petalLetters[index] = newLetter;
  input.value = newLetter;

  // Update visual state
  updatePetalVisualState();

  // Track petal entry
  if (newLetter.length === 1 && previousValue.length === 0) {
    safeTrack('petal_letter_entered', {
      'event_category': 'blossom_solver',
      'event_label': `petal_${index + 1}_filled`,
      'value': index + 1,
      'custom_parameters': {
        'petal_position': index + 1,
        'letter': newLetter.toLowerCase(),
        'letters_filled': petalLetters.filter(l => l).length,
        'time_since_start': Date.now() - sessionStartTime
      }
    });
    
    // Auto-advance to next empty cell
    const nextEmpty = findNextEmptyCell('petal'); // Pass context that we're working on petals
    if (nextEmpty) {
      document.getElementById(nextEmpty.element).focus();
    } else {
      // All cells filled, blur current input
      input.blur();
      
      // Track completion
      safeTrack('all_letters_complete', {
        'event_category': 'blossom_solver',
        'event_label': 'full_puzzle_entered',
        'value': 7,
        'custom_parameters': {
          'time_to_complete': Date.now() - sessionStartTime,
          'center_letter': centerLetter.toLowerCase(),
          'petal_letters': petalLetters.join('').toLowerCase(),
          'unique_letters': new Set([centerLetter, ...petalLetters].filter(l => l)).size
        }
      });
    }
  }
  
  // Track petal letter change
  if (previousValue !== newLetter && newLetter.length > 0) {
    safeTrack('letter_changed', {
      'event_category': 'blossom_solver',
      'event_label': 'petal_letter_modified',
      'custom_parameters': {
        'from_letter': previousValue.toLowerCase(),
        'to_letter': newLetter.toLowerCase(),
        'petal_position': index + 1,
        'change_type': 'petal'
      }
    });
  }
  
  updateHiddenInputs();
  lastInteractionTime = Date.now();
}

// Remove the duplicate selectPetal function (keep only this one):
function selectPetal(index) {
  // Only allow button mode when all letters are entered
  if (!areAllLettersEntered()) {
    // If not all letters entered, focus the input instead
    document.getElementById(`petal-${index}`).focus();
    return;
  }

  if (!centerLetter) {
    showCenterWarning();
    return;
  }

  if (petalLetters[index]) {
    const previousSelected = selectedPetal;
    selectedPetal = petalLetters[index];
    document.querySelector('input[name="petal_letter"]').value = selectedPetal;
    
    // Update visual selection
    document.querySelectorAll('.petal-button').forEach(btn => btn.classList.remove('selected'));
    document.querySelector(`.petal-${index + 1}`).classList.add('selected');
    
    // Track petal selection
    safeTrack('bonus_letter_selected', {
      'event_category': 'blossom_solver',
      'event_label': `bonus_${selectedPetal.toLowerCase()}`,
      'value': index + 1,
      'custom_parameters': {
        'selected_letter': selectedPetal.toLowerCase(),
        'petal_position': index + 1,
        'total_letters': petalLetters.filter(l => l).length,
        'is_reselection': previousSelected === selectedPetal,
        'time_since_last_interaction': Date.now() - lastInteractionTime,
        'session_duration': Date.now() - sessionStartTime
      }
    });
    
    // Track form submission
    safeTrack('form_submitted', {
      'event_category': 'blossom_solver',
      'event_label': 'solve_request',
      'custom_parameters': {
        'center_letter': centerLetter.toLowerCase(),
        'bonus_letter': selectedPetal.toLowerCase(),
        'all_letters': [centerLetter, ...petalLetters].filter(l => l).join('').toLowerCase()
      }
    });
    
    // Submit form
    document.querySelector('form[name="form1"]').submit();
  }
}

// Function to handle backspace navigation
function handleBackspace(input, index, isCenter) {
  if (input.value === '') {
    if (isCenter) return;
    
    // Track backspace navigation
    safeTrack('navigation', {
      'event_category': 'blossom_solver',
      'event_label': 'backspace_navigation',
      'custom_parameters': {
        'from_position': isCenter ? 'center' : `petal_${index + 1}`,
        'to_position': index > 0 ? `petal_${index}` : 'center'
      }
    });
    
    if (index > 0) {
      document.getElementById(`petal-${index - 1}`).focus();
    } else {
      document.getElementById('center-input').focus();
    }
  }
}

// Track focus events
function trackFocus(elementType, index) {
  safeTrack('input_focus', {
    'event_category': 'blossom_solver',
    'event_label': `focus_${elementType}`,
    'custom_parameters': {
      'element_type': elementType,
      'position': elementType === 'center' ? 'center' : index + 1,
      'time_since_last_interaction': Date.now() - lastInteractionTime
    }
  });
  lastInteractionTime = Date.now();
}

// Track external link clicks
function trackExternalLink(linkText, url) {
  safeTrack('external_link_click', {
    'event_category': 'blossom_solver',
    'event_label': linkText,
    'custom_parameters': {
      'link_text': linkText,
      'destination_url': url,
      'session_duration': Date.now() - sessionStartTime
    }
  });
}

// Track internal navigation
function trackInternalNavigation(destination) {
  safeTrack('internal_navigation', {
    'event_category': 'blossom_solver',
    'event_label': destination,
    'custom_parameters': {
      'destination': destination,
      'session_duration': Date.now() - sessionStartTime,
      'letters_entered': [centerLetter, ...petalLetters].filter(l => l).length
    }
  });
}

// Track tooltip interactions
function trackTooltipHover() {
  safeTrack('tooltip_interaction', {
    'event_category': 'blossom_solver',
    'event_label': 'disclaimer_tooltip_hover',
    'custom_parameters': {
      'tooltip_type': 'disclaimer',
      'session_duration': Date.now() - sessionStartTime
    }
  });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  // Get initial values from template
  const initialCenter = '{{must_have_val}}';
  const initialPetals = '{{may_have_val}}';
  const initialSelectedPetal = '{{petal_letter}}';
  const currentCount = '{{current_count|default(25)}}';
  const showLoadMore = '{{show_load_more}}' === 'True';
  
  // Set initial values
  if (initialCenter) {
    centerLetter = initialCenter.toUpperCase();
    document.getElementById('center-input').value = centerLetter;
  }
  
  if (initialPetals) {
    for (let i = 0; i < initialPetals.length && i < 6; i++) {
      petalLetters[i] = initialPetals[i].toUpperCase();
      document.getElementById(`petal-${i}`).value = petalLetters[i];
    }
  }
  
  // Highlight selected petal
  if (initialSelectedPetal) {
    const petalIndex = petalLetters.indexOf(initialSelectedPetal.toUpperCase());
    if (petalIndex !== -1) {
      document.querySelector(`.petal-${petalIndex + 1}`).classList.add('selected');
    }
  }
  
  // Add event listeners to checkboxes
  const checkboxes = document.querySelectorAll('.word-checkbox');
  let checkedCount = 0;
  checkboxes.forEach(checkbox => {
    const row = checkbox.closest('tr');
    if (checkbox.checked) {
      row.classList.add('used-word');
      checkedCount++;
    }
    
    checkbox.addEventListener('change', function() {
      handleCheckboxChange(this);
    });
  });
  
  // Add focus tracking to inputs
  document.getElementById('center-input').addEventListener('focus', () => trackFocus('center', 0));
  for (let i = 0; i < 6; i++) {
    document.getElementById(`petal-${i}`).addEventListener('focus', () => trackFocus('petal', i));
  }
  
  // Add tooltip tracking
  const tooltip = document.querySelector('.disclaimer-tooltip');
  if (tooltip) {
    tooltip.addEventListener('mouseenter', trackTooltipHover);
  }
  
  // Add link tracking
  document.querySelectorAll('a').forEach(link => {
    link.addEventListener('click', function(e) {
      const href = this.getAttribute('href');
      const text = this.textContent.trim();
      
      if (href.startsWith('http')) {
        trackExternalLink(text, href);
      } else if (href && !href.startsWith('#')) {
        trackInternalNavigation(text);
      }
    });
  });
  
  // Track scroll depth
  let maxScrollDepth = 0;
  let scrollTracked = false;
  window.addEventListener('scroll', function() {
    const scrollPercentage = Math.round((window.scrollY + window.innerHeight) / document.documentElement.scrollHeight * 100);
    if (scrollPercentage > maxScrollDepth) {
      maxScrollDepth = scrollPercentage;
      
      // Track significant scroll milestones
      if (scrollPercentage >= 90 && !scrollTracked) {
        scrollTracked = true;
        safeTrack('scroll_depth', {
          'event_category': 'blossom_solver',
          'event_label': 'reached_bottom',
          'value': 90,
          'custom_parameters': {
            'max_scroll_percentage': maxScrollDepth,
            'session_duration': Date.now() - sessionStartTime
          }
        });
      }
    }
  });
  
  // Track initial page view with comprehensive data
  safeTrack('page_view', {
    'event_category': 'blossom_solver',
    'event_label': 'solver_loaded',
    'custom_parameters': {
      'has_existing_data': centerLetter.length > 0 || petalLetters.join('').length > 0,
      'center_letter_present': centerLetter.length > 0,
      'petal_letters_count': petalLetters.filter(l => l).length,
      'petal_letters_complete': petalLetters.join('').length === 6,
      'selected_petal': initialSelectedPetal || 'none',
      'words_displayed': parseInt(currentCount) || 25,
      'has_more_words': showLoadMore,
      'words_marked_used': checkedCount,
      'page_type': 'blossom_solver',
      'viewport_width': window.innerWidth,
      'viewport_height': window.innerHeight,
      'device_type': window.innerWidth < 768 ? 'mobile' : 'desktop'
    }
  });
  
  // Track session engagement when leaving
  window.addEventListener('beforeunload', function() {
    safeTrack('session_end', {
      'event_category': 'blossom_solver',
      'event_label': 'user_exit',
      'value': Math.round((Date.now() - sessionStartTime) / 1000),
      'custom_parameters': {
        'session_duration_seconds': Math.round((Date.now() - sessionStartTime) / 1000),
        'letters_entered': [centerLetter, ...petalLetters].filter(l => l).length,
        'words_marked': document.querySelectorAll('.word-checkbox:checked').length,
        'max_scroll_depth': maxScrollDepth
      }
    });
  });

  // Auto-focus center input on first load if it's empty
  if (!centerLetter) {
    document.getElementById('center-input').focus();
  }

  // Initial visual state update
  updatePetalVisualState();
});

// Enhanced checkbox handling function
function handleCheckboxChange(checkbox) {
  const word = checkbox.getAttribute('data-word');
  const row = checkbox.closest('tr');
  const isChecking = checkbox.checked;
  const wordLength = word ? word.length : 0;
  const wordScore = parseInt(row.querySelector('td:nth-child(3)')?.textContent) || 0;
  
  if (isChecking) {
    row.classList.add('used-word');
  } else {
    row.classList.remove('used-word');
  }

  // Track word interaction with enhanced data
  safeTrack('word_interaction', {
    'event_category': 'blossom_solver',
    'event_label': isChecking ? 'word_marked_used' : 'word_unmarked',
    'value': wordScore,
    'custom_parameters': {
      'word_length': wordLength,
      'word': word,
      'word_score': wordScore,
      'action': isChecking ? 'mark' : 'unmark',
      'total_marked': document.querySelectorAll('.word-checkbox:checked').length,
      'time_since_last_interaction': Date.now() - lastInteractionTime,
      'session_duration': Date.now() - sessionStartTime
    }
  });

  lastInteractionTime = Date.now();

  // Server sync
  fetch('/blossom', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      action: 'toggle_word',
      word: word
    })
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    return response.json();
  })
  .then(data => {
    if (data.status === 'success') {
      safeTrack('word_status_updated', {
        'event_category': 'blossom_solver',
        'event_label': 'server_sync_success',
        'custom_parameters': {
          'word': word,
          'new_status': isChecking ? 'used' : 'available',
          'sync_time': Date.now() - lastInteractionTime
        }
      });
    }
  })
  .catch(error => {
    console.error('Error updating word status:', error);
    
    // Track sync error
    safeTrack('sync_error', {
      'event_category': 'blossom_solver',
      'event_label': 'word_sync_failed',
      'custom_parameters': {
        'word': word,
        'error_message': error.message
      }
    });
    
    // Revert checkbox state
    checkbox.checked = !checkbox.checked;
    if (checkbox.checked) {
      row.classList.add('used-word');
    } else {
      row.classList.remove('used-word');
    }
  });
}

// Track load more button
function trackLoadMore() {
  const currentWords = parseInt(document.querySelector('input[name="current_count"]').value) || 25;
  
  safeTrack('load_more_clicked', {
    'event_category': 'blossom_solver',
    'event_label': 'show_more_words',
    'value': currentWords + 25,
    'custom_parameters': {
      'current_word_count': currentWords,
      'new_word_count': currentWords + 25,
      'session_duration': Date.now() - sessionStartTime
    }
  });
}

// Track reset action
function trackReset() {
  safeTrack('puzzle_reset', {
    'event_category': 'blossom_solver',
    'event_label': 'reset_letters',
    'custom_parameters': {
      'had_center_letter': centerLetter.length > 0,
      'had_petal_letters': petalLetters.filter(l => l).length,
      'words_marked': document.querySelectorAll('.word-checkbox:checked').length,
      'session_duration': Date.now() - sessionStartTime
    }
  });
}

document.getElementById('center-input').focus();

function showCenterWarning() {
  const warning = document.getElementById('center-warning');
  warning.style.display = 'block';
  warning.style.opacity = '1';

  setTimeout(() => {
    warning.style.transition = 'opacity 0.5s ease';
    warning.style.opacity = '0';
  }, 1500);

  setTimeout(() => {
    warning.style.display = 'none';
    warning.style.transition = '';
  }, 2000);
}


// Enhanced function to update visual state of petals
function updatePetalVisualState() {
  const allLettersEntered = areAllLettersEntered();
  const petals = document.querySelectorAll('.petal-button');
  
  petals.forEach((petal, index) => {
    if (allLettersEntered && petalLetters[index].length === 1) {
      petal.classList.add('button-mode');
      petal.title = `Click to solve with bonus letter ${petalLetters[index]}`;
    } else {
      petal.classList.remove('button-mode');
      petal.classList.remove('selected'); // Remove selection if not in button mode
      petal.title = 'Click to enter a letter';
    }
  });
  
  // Update instruction text if needed
  const instruction = document.querySelector('.pad_lr_30');
  if (instruction) {
    if (allLettersEntered) {
      instruction.textContent = 'All letters entered! Click any petal to calculate words with that bonus letter.';
    } else {
      instruction.textContent = 'Enter your letters below. Click any petal to calculate words with that bonus letter.';
    }
  }
}

// Add this to the DOMContentLoaded event listener at the end:
// Initial visual state update
updatePetalVisualState();

// Function to check for duplicate letters
function checkForDuplicates(newLetter, currentIndex, isCenter = false) {
  const allLetters = [centerLetter, ...petalLetters];
  const newLetterUpper = newLetter.toUpperCase();
  
  // Check against all other positions
  for (let i = 0; i < allLetters.length; i++) {
    const existingLetter = allLetters[i];
    
    // Skip empty letters and the current position being edited
    if (!existingLetter) continue;
    
    // For center letter, skip center position (index would be -1 or special case)
    if (isCenter && i === 0) continue;
    
    // For petal letters, skip the current petal position
    if (!isCenter && i === currentIndex + 1) continue;
    
    // Check for duplicate
    if (existingLetter.toUpperCase() === newLetterUpper) {
      return {
        isDuplicate: true,
        position: i === 0 ? 'center' : `petal ${i}`,
        letter: existingLetter
      };
    }
  }
  
  return { isDuplicate: false };
}

// Function to show duplicate warning
function showDuplicateWarning(letter, position) {
  // Remove existing warning if any
  const existingWarning = document.getElementById('duplicate-warning');
  if (existingWarning) {
    existingWarning.remove();
  }
  
  // Create warning element
  const warning = document.createElement('div');
  warning.id = 'duplicate-warning';
  warning.style.cssText = `
    display: block;
    position: fixed;
    top: 70px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #ff6b6b;
    color: white;
    padding: 12px 20px;
    border: 2px solid #e55555;
    border-radius: 6px;
    font-weight: bold;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    z-index: 2001;
    font-size: 14px;
  `;
  warning.textContent = `Letter "${letter}" is already used in the ${position}!`;
  
  document.body.appendChild(warning);
  
  // Track duplicate attempt
  safeTrack('duplicate_letter_attempt', {
    'event_category': 'blossom_solver',
    'event_label': 'duplicate_blocked',
    'custom_parameters': {
      'attempted_letter': letter.toLowerCase(),
      'existing_position': position,
      'session_duration': Date.now() - sessionStartTime
    }
  });

  // Auto-remove warning after 3 seconds
  setTimeout(() => {
    if (warning && warning.parentNode) {
      warning.style.transition = 'opacity 0.5s ease';
      warning.style.opacity = '0';
      setTimeout(() => {
        if (warning && warning.parentNode) {
          warning.remove();
        }
      }, 500);
    }
  }, 2500);
}

// Function to find the next empty cell, with context awareness
function findNextEmptyCell(currentContext = 'any') {
  if (currentContext === 'petal') {
    // When working on petals, prioritize other empty petals first
    for (let i = 0; i < 6; i++) {
      if (!petalLetters[i]) {
        return { type: 'petal', index: i, element: `petal-${i}` };
      }
    }
    
    // Then check center if all petals are filled
    if (!centerLetter) {
      return { type: 'center', index: -1, element: 'center-input' };
    }
  } else {
    // Default behavior: center first, then petals
    if (!centerLetter) {
      return { type: 'center', index: -1, element: 'center-input' };
    }
    
    // Then check petals in order
    for (let i = 0; i < 6; i++) {
      if (!petalLetters[i]) {
        return { type: 'petal', index: i, element: `petal-${i}` };
      }
    }
  }
  
  return null; // All filled
}

</script>

<form name="form1" action="/blossom" method="post">
  <center>

  <div id="center-warning" style="
    display: none;
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #ffd700;
    color: #02484d;
    padding: 10px 20px;
    border: 2px solid #02484d;
    border-radius: 6px;
    font-weight: bold;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    z-index: 2000;
  ">
    Please enter the center letter first.
  </div>

  <input type="hidden" name="current_count" value="{{current_count|default(25)}}">
  <input type="hidden" name="must_have" value="{{must_have_val}}">
  <input type="hidden" name="may_have" value="{{may_have_val}}">
  <input type="hidden" name="petal_letter" value="{{petal_letter}}">

  <br>
  <h1 style="text-align: center; font-size: clamp(1.5rem, 4vw, 2.5rem); line-height: 1.2;">Blossom Word Finder & Solver</h1>

  <p class="pad_lr_30" style="text-align: center">Enter your letters below. Click any petal to calculate words with that bonus letter.</p>
  <br>

  <!-- New Blossom Layout -->
  <div class="blossom-container">

    <!-- Center Letter -->
    <div class="center-letter">
      <input type="text" id="center-input" maxlength="1" placeholder="A" 
             oninput="handleCenterInput(this)" 
             onkeydown="if(event.key === 'Backspace') handleBackspace(this, 0, true)">
    </div>
    
    <!-- Petal Letters -->
    <button type="button" class="petal-button petal-1" onclick="selectPetal(0)">
      <input type="text" id="petal-0" maxlength="1" placeholder="B" 
            oninput="handlePetalInput(this, 0)" 
            onkeydown="if(event.key === 'Backspace') handleBackspace(this, 0, false)">
    </button>

    <button type="button" class="petal-button petal-2" onclick="selectPetal(1)">
      <input type="text" id="petal-1" maxlength="1" placeholder="C" 
            oninput="handlePetalInput(this, 1)" 
            onkeydown="if(event.key === 'Backspace') handleBackspace(this, 1, false)">
    </button>

    <button type="button" class="petal-button petal-3" onclick="selectPetal(2)">
      <input type="text" id="petal-2" maxlength="1" placeholder="D" 
            oninput="handlePetalInput(this, 2)" 
            onkeydown="if(event.key === 'Backspace') handleBackspace(this, 2, false)">
    </button>

    <button type="button" class="petal-button petal-4" onclick="selectPetal(3)">
      <input type="text" id="petal-3" maxlength="1" placeholder="E" 
            oninput="handlePetalInput(this, 3)" 
            onkeydown="if(event.key === 'Backspace') handleBackspace(this, 3, false)">
    </button>

    <button type="button" class="petal-button petal-5" onclick="selectPetal(4)">
      <input type="text" id="petal-4" maxlength="1" placeholder="F" 
            oninput="handlePetalInput(this, 4)" 
            onkeydown="if(event.key === 'Backspace') handleBackspace(this, 4, false)">
    </button>

    <button type="button" class="petal-button petal-6" onclick="selectPetal(5)">
      <input type="text" id="petal-5" maxlength="1" placeholder="G" 
            oninput="handlePetalInput(this, 5)" 
            onkeydown="if(event.key === 'Backspace') handleBackspace(this, 5, false)">
    </button>
  </div>
  
  <a href="/blossom/reset" class="browse-button" style="font-size: 14px; padding: 8px 16px; margin-top: -50px;">Reset Letters</a>
  <br>
  <br>

  {{blossom_table|safe}}
  <br>
  {% if show_load_more %}
  <form method="POST" action="/blossom" style="display: inline;">
    <input type="hidden" name="must_have" value="{{must_have_val}}">
    <input type="hidden" name="may_have" value="{{may_have_val}}">
    <input type="hidden" name="petal_letter" value="{{petal_letter}}">
    <input type="hidden" name="current_count" value="{{current_count}}">
    <button type="submit" name="load_more" value="true" style="
        background-color: #f5f5f5;
        border: 1px solid #ddd;
        color: #666;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        font-family: inherit;
    ">+ Show 25 more</button>
  </form>
  <br>
  <br>
  {% endif %}
  {{valid_word_count}}

  <br>
  <br>
  <br>
  <p style="text-align: center; max-width: 800px; margin: 0 auto; padding: 0 20px;">
    Blossom is Merriam-Webster's daily word puzzle where you create words using a center letter and surrounding petals. Enter your letters above to find all possible words and solve today's puzzle instantly.
  </p>
  <br>
  <br>
  <a href="https://www.merriam-webster.com/games/blossom-word-game" target="_blank" class="browse-button">Go To Blossom Game</a>
  <a href="/feedback" class="browse-button">Give Feedback Here</a>
  <br>
  <br>
  <a href="/wordle" class="browse-button">Wordle Solver</a>
  <a href="/quordle" class="browse-button">Quordle Solver</a>
  <a href="/antiwordle" class="browse-button">Antiwordle Solver</a>
  <a href="/blossom_bee" class="browse-button">Spelling Bee Solver</a>
  <br>
  </p>
  <p style="text-align: center; max-width: 800px; margin: 0 auto; padding: 0 20px;">
    <span class="disclaimer-tooltip">
      About this tool
      <span class="tooltip-content">
        This is an unofficial tool to help with Merriam-Webster's Blossom word game. The word list comes from this <a href="https://github.com/MagicOctopusUrn/wordListsByLength" target="_blank" rel="noopener noreferrer">GitHub</a> and may not always align with the valid words in the official game. Results are provided for assistance and entertainment purposes only. This tool is not affiliated with or endorsed by Merriam-Webster.
      </span>
    </span>
  </p>
  <br>
  <br>
  </center>
</form>

{% endblock %}